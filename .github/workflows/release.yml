name: MAUI Release Build

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  PROJECT_NAME: MauiCalculator

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install MAUI workload
      run: dotnet workload install maui

    # --------------------
    # VERSION PARSING
    # --------------------
    - name: Parse version
      shell: pwsh
      run: |
        $tag = "${{ github.ref_name }}".TrimStart('v')
        $parts = $tag.Split('.')
        $intVersion = "$($parts[0])$($parts[1])$($parts[2])"

        echo "DISPLAY_VERSION=$tag" >> $env:GITHUB_ENV
        echo "APP_VERSION=$intVersion" >> $env:GITHUB_ENV

    # --------------------
    # RESTORE
    # --------------------
    - name: Restore
      run: dotnet restore MauiCalculator.csproj

    # --------------------
    # WINDOWS MSIX
    # --------------------
    - name: Build Windows MSIX
      run: |
        dotnet publish MauiCalculator.csproj `
          -f net9.0-windows10.0.19041.0 `
          -c Release `
          -p:ApplicationDisplayVersion=${{ env.DISPLAY_VERSION }} `
          -p:ApplicationVersion=${{ env.APP_VERSION }} `
          -p:GenerateAppxPackageOnBuild=true `
          -o ./artifacts/windows

    # --------------------
    # ANDROID APK
    # --------------------
    - name: Build Android APK
      run: |
        dotnet publish MauiCalculator.csproj `
          -f net9.0-android `
          -c Release `
          -p:ApplicationDisplayVersion=${{ env.DISPLAY_VERSION }} `
          -p:ApplicationVersion=${{ env.APP_VERSION }} `
          -o ./artifacts/android

    # --------------------
    # RELEASE
    # --------------------
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: "${{ env.PROJECT_NAME }} ${{ github.ref_name }}"
        tag_name: ${{ github.ref_name }}
        files: |
          artifacts/windows/*.msix
          artifacts/android/*.apk
        body: |
          ## ðŸš€ ${{ env.PROJECT_NAME }} ${{ github.ref_name }}

          ### âœ¨ Changes
          - .NET 9 migration
          - Windows MSIX installer
          - Android APK build
          - Automated CI/CD release pipeline
