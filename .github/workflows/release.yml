name: MAUI Release Build

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  PROJECT_NAME: MauiCalculator
  TAG_VERSION: ${{ github.ref_name }}

jobs:
  build:
    runs-on: windows-latest

    steps:
    # --------------------
    # CHECKOUT
    # --------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------
    # SETUP DOTNET 9
    # --------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    # --------------------
    # INSTALL MAUI
    # --------------------
    - name: Install MAUI workload
      run: dotnet workload install maui

    # --------------------
    # NORMALIZE VERSION
    # --------------------
    - name: Normalize version
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        echo "APP_VERSION=$version" >> $env:GITHUB_ENV

    # --------------------
    # RESTORE
    # --------------------
    - name: Restore dependencies
      run: dotnet restore MauiCalculator.csproj -p:ApplicationVersion=${{ env.APP_VERSION }}

    # --------------------
    # BUILD WINDOWS (MSIX)
    # --------------------
    - name: Build Windows MSIX
      run: |
        dotnet publish MauiCalculator.csproj `
          -f net9.0-windows10.0.19041.0 `
          -c Release `
          -p:ApplicationVersion=${{ env.APP_VERSION }} `
          -p:GenerateAppxPackageOnBuild=true `
          -o ./artifacts/windows

    # --------------------
    # RENAME WINDOWS MSIX
    # --------------------
    - name: Rename Windows MSIX
      shell: pwsh
      run: |
        $msix = Get-ChildItem artifacts/windows -Filter *.msix | Select-Object -First 1
        Rename-Item $msix.FullName "$env:PROJECT_NAME-$env:TAG_VERSION-Windows.msix"

    # --------------------
    # BUILD ANDROID (APK)
    # --------------------
    - name: Build Android APK
      run: |
        dotnet publish MauiCalculator.csproj `
          -f net9.0-android `
          -c Release `
          -p:ApplicationVersion=${{ env.APP_VERSION }} `
          -o ./artifacts/android

    # --------------------
    # RENAME ANDROID APK
    # --------------------
    - name: Rename Android APK
      shell: pwsh
      run: |
        $apk = Get-ChildItem artifacts/android -Filter *.apk | Select-Object -First 1
        Rename-Item $apk.FullName "$env:PROJECT_NAME-$env:TAG_VERSION-Android.apk"

    # --------------------
    # CREATE GITHUB RELEASE
    # --------------------
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: "${{ env.PROJECT_NAME }} ${{ env.TAG_VERSION }}"
        tag_name: ${{ env.TAG_VERSION }}
        body: |
          ## ðŸš€ ${{ env.PROJECT_NAME }} ${{ env.TAG_VERSION }}

          ### âœ¨ What's New
          - Migrated project to **.NET 9**
          - Added **Windows MSIX installer**
          - Added **Android APK build**
          - Improved calculator UI & theming
          - Automated CI/CD with GitHub Actions

          ### ðŸ“¦ Downloads
          - **Windows**: MSIX installer
          - **Android**: APK package

          ---
          Built automatically via GitHub Actions ðŸ¤–
        files: |
          artifacts/windows/*.msix
          artifacts/android/*.apk
